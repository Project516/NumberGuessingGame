plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'

    //Spotless
    id 'com.diffplug.spotless' version '8.0.0'
    
    // Java plugin for TeaVM support
    id 'java'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // This dependency is used by the application.
    implementation libs.guava
    
    // TeaVM - JavaScript compiler and browser APIs
    implementation "org.teavm:teavm-core:${libs.versions.teavm.get()}"
    implementation "org.teavm:teavm-classlib:${libs.versions.teavm.get()}"
    implementation libs.teavm.jso.apis
}

testing {
    suites {
        // Configure the built-in test suite
        test {
            // Use JUnit Jupiter test framework
            useJUnitJupiter('6.0.0')
        }
    }
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        // Use JDK 21
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'io.github.project516.NumberGuessingGame.Main'
}

compileJava.dependsOn spotlessApply

spotless {
    java {
        googleJavaFormat('1.28.0').aosp()
        target 'src/**/*.java'
        removeUnusedImports()
    }
}

// TeaVM custom task to compile Java to JavaScript
// Note: We use a custom task instead of the TeaVM Gradle plugin due to compatibility issues with Gradle 9
configurations {
    teavmCompile
}

dependencies {
    teavmCompile "org.teavm:teavm-tooling:${libs.versions.teavm.get()}"
}

task compileToJs {
    group = 'teavm'
    description = 'Compile Java to JavaScript using TeaVM'
    
    def outputDir = file("$buildDir/teavm")
    outputs.dir(outputDir)
    inputs.files(sourceSets.main.output)
    
    // Store classpath as a property to avoid configuration cache issues
    def teavmClasspath = configurations.teavmCompile + sourceSets.main.runtimeClasspath
    
    dependsOn classes
    
    doLast {
        outputDir.mkdirs()
        
        // Use TeaVM API directly
        def loader = new URLClassLoader(
            teavmClasspath.files.collect { it.toURI().toURL() } as URL[],
            getClass().classLoader
        )
        
        def toolClass = loader.loadClass('org.teavm.tooling.TeaVMTool')
        def optLevelClass = loader.loadClass('org.teavm.vm.TeaVMOptimizationLevel')
        
        def tool = toolClass.newInstance()
        tool.setTargetDirectory(outputDir)
        tool.setTargetFileName('NumberGuessingGame.js')
        tool.setMainClass('io.github.project516.NumberGuessingGame.BrowserMain')
        tool.setOptimizationLevel(optLevelClass.SIMPLE)
        tool.setDebugInformationGenerated(true)
        tool.setSourceMapsFileGenerated(true)
        tool.setSourceFilesCopied(true)
        tool.setClassLoader(loader)
        
        println 'Starting TeaVM compilation...'
        tool.generate()
        println 'TeaVM compilation complete!'
    }
}

// Copy HTML page to TeaVM output directory
task copyTeaVMResources(type: Copy) {
    group = 'teavm'
    description = 'Copy HTML and resources to TeaVM output directory'
    
    from 'src/main/webapp'
    into "$buildDir/teavm"
    
    dependsOn compileToJs
}

task buildTeaVM {
    group = 'teavm'
    description = 'Build complete TeaVM application'
    
    dependsOn copyTeaVMResources
}

// Jar config
jar {
    manifest {
        attributes(
            'Main-Class': 'io.github.project516.NumberGuessingGame.Main'
        )
    }
}
